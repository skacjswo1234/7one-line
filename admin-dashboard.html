<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 - 7one-line</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gmarket+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gmarket Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* 사이드바 애니메이션 */
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        /* 데스크톱: 왼쪽에 고정, 항상 표시 */
        @media (min-width: 1024px) {
            .sidebar {
                left: 0;
                right: auto;
                transform: translateX(0) !important;
            }
            
            .sidebar.mobile-hidden {
                transform: translateX(0) !important;
            }
        }
        
        /* 모바일: 오른쪽에 위치, 기본적으로 숨김 */
        @media (max-width: 1023px) {
            .sidebar {
                right: 0;
                left: auto;
            }
            
            .sidebar.mobile-hidden {
                transform: translateX(100%);
            }
        }
        
        /* 모바일 오버레이 */
        .mobile-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        
        .mobile-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        /* 탭 콘텐츠 */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 활성 탭 스타일 */
        .nav-item.active {
            background-color: #1e40af;
            color: white;
        }
    </style>
</head>
<body class="dark bg-gray-900 min-h-screen">

    <!-- 모바일 오버레이 -->
    <div 
        id="mobileOverlay" 
        class="mobile-overlay hidden fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
        onclick="closeMobileMenu()"
    ></div>

    <!-- 사이드바 네비게이션 -->
    <aside 
        id="sidebar" 
        class="sidebar fixed top-0 h-full w-64 bg-gray-800 border-r border-gray-700 z-40 mobile-hidden"
    >
        <div class="p-6 border-b border-gray-700 flex items-center justify-between">
            <h1 class="text-xl font-bold text-white">관리자 대시보드</h1>
            <!-- 모바일 닫기 버튼 -->
            <button 
                onclick="closeMobileMenu()" 
                class="lg:hidden text-gray-400 hover:text-white transition"
                aria-label="메뉴 닫기"
            >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <nav class="p-4 space-y-2">
            <button 
                onclick="switchTab('links')" 
                class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition active"
                data-tab="links"
            >
                <span class="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    링크 관리
                </span>
            </button>
            
            <button 
                onclick="switchTab('add-link')" 
                class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition"
                data-tab="add-link"
            >
                <span class="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    링크 등록
                </span>
            </button>
            
            <button 
                onclick="switchTab('password')" 
                class="nav-item w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition"
                data-tab="password"
            >
                <span class="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    비밀번호 변경
                </span>
            </button>
        </nav>
        
        <div class="absolute bottom-4 left-4 right-4">
            <div class="flex items-center gap-4 mb-4">
                <a href="index.html" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition">
                    메인 페이지로
                </a>
            </div>
            <button 
                onclick="logout()" 
                class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-medium"
            >
                로그아웃
            </button>
        </div>
    </aside>

    <!-- 메인 콘텐츠 영역 -->
    <main class="lg:ml-64 min-h-screen">
        <!-- 헤더 (모바일용) -->
        <header class="lg:hidden bg-gray-800 shadow-lg border-b border-gray-700 sticky top-0 z-30">
            <div class="flex items-center justify-between p-4">
                <h1 class="text-lg font-bold text-white">관리자 대시보드</h1>
                <button 
                    id="mobileMenuBtnHeader" 
                    class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-600 transition"
                    aria-label="메뉴 열기"
                >
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- 콘텐츠 -->
        <div class="p-4 lg:p-8">
            <!-- 링크 관리 탭 -->
            <div id="tab-links" class="tab-content active">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-6">링크 관리</h2>
                    
                    <div id="linksContainer" class="space-y-4">
                        <!-- 링크 목록이 여기에 동적으로 로드됩니다 -->
                    </div>

                    <div id="successMessage" class="hidden mt-4 bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm">
                    </div>

                    <div id="errorMessage" class="hidden mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm">
                    </div>
                </div>
            </div>

            <!-- 링크 등록 탭 -->
            <div id="tab-add-link" class="tab-content">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-6">링크 등록</h2>
                    
                    <form id="addLinkForm" class="space-y-4">
                        <div>
                            <label for="linkName" class="block text-sm font-medium text-gray-300 mb-2">
                                링크 이름 (식별자) <span class="text-red-400">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="linkName" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="예: hero_button, phone_button"
                            >
                            <p class="mt-1 text-xs text-gray-400">영문, 숫자, 언더스코어만 사용 가능합니다.</p>
                        </div>

                        <div>
                            <label for="linkUrl" class="block text-sm font-medium text-gray-300 mb-2">
                                링크 URL <span class="text-red-400">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="linkUrl" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="예: #loan-apply 또는 https://example.com"
                            >
                        </div>

                        <div>
                            <label for="linkDescription" class="block text-sm font-medium text-gray-300 mb-2">
                                설명 (선택사항)
                            </label>
                            <input 
                                type="text" 
                                id="linkDescription" 
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="링크에 대한 설명을 입력하세요"
                            >
                        </div>

                        <div id="addLinkSuccessMessage" class="hidden bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm">
                        </div>

                        <div id="addLinkErrorMessage" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm">
                        </div>

                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold"
                        >
                            링크 등록
                        </button>
                    </form>
                </div>
            </div>

            <!-- 비밀번호 변경 탭 -->
            <div id="tab-password" class="tab-content">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-6">비밀번호 변경</h2>
                    
                    <form id="passwordForm" class="space-y-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-300 mb-2">
                                현재 비밀번호
                            </label>
                            <input 
                                type="password" 
                                id="currentPassword" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="현재 비밀번호를 입력하세요"
                            >
                        </div>

                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-300 mb-2">
                                새 비밀번호
                            </label>
                            <input 
                                type="password" 
                                id="newPassword" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="새 비밀번호를 입력하세요"
                            >
                        </div>

                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-300 mb-2">
                                새 비밀번호 확인
                            </label>
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                required
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                                placeholder="새 비밀번호를 다시 입력하세요"
                            >
                        </div>

                        <div id="passwordSuccessMessage" class="hidden bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg text-sm">
                        </div>

                        <div id="passwordErrorMessage" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg text-sm">
                        </div>

                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold"
                        >
                            비밀번호 변경
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 로그인 확인
        if (!sessionStorage.getItem('adminLoggedIn')) {
            window.location.href = 'admin.html';
        }

        // 로그아웃
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            window.location.href = 'admin.html';
        }

        // 모바일 메뉴 열기/닫기
        const mobileMenuBtn = document.getElementById('mobileMenuBtnHeader');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        function openMobileMenu() {
            if (window.innerWidth < 1024) {
                sidebar.classList.remove('mobile-hidden');
                mobileOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeMobileMenu() {
            if (window.innerWidth < 1024) {
                sidebar.classList.add('mobile-hidden');
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        mobileMenuBtn?.addEventListener('click', function() {
            openMobileMenu();
        });

        // 윈도우 리사이즈 시 데스크톱으로 전환되면 모바일 메뉴 닫기
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                closeMobileMenu();
            }
        });

        // ESC 키로 모바일 메뉴 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && window.innerWidth < 1024) {
                closeMobileMenu();
            }
        });

        // 탭 전환
        function switchTab(tabName) {
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 모든 네비게이션 아이템 비활성화
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // 선택한 탭 표시
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // 선택한 네비게이션 아이템 활성화
            const selectedNav = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedNav) {
                selectedNav.classList.add('active');
            }

            // 모바일에서 탭 전환 시 메뉴 닫기
            if (window.innerWidth < 1024) {
                closeMobileMenu();
            }

            // 링크 관리 탭으로 전환 시 링크 다시 로드
            if (tabName === 'links') {
                loadLinks();
            }
        }

        // 링크 로드
        async function loadLinks() {
            try {
                const response = await fetch('/api/links');
                const data = await response.json();
                
                if (data.success) {
                    displayLinks(data.data);
                } else {
                    showError('링크를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                showError('네트워크 오류가 발생했습니다.');
            }
        }

        // 링크 표시
        function displayLinks(links) {
            const container = document.getElementById('linksContainer');
            
            if (links.length === 0) {
                container.innerHTML = '<p class="text-gray-400">등록된 링크가 없습니다.</p>';
                return;
            }

            container.innerHTML = links.map(link => `
                <div class="border border-gray-700 rounded-lg p-4 bg-gray-700">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            링크 이름: <span class="font-bold text-blue-400">${link.name}</span>
                        </label>
                        ${link.description ? `<p class="text-sm text-gray-400 mb-2">${link.description}</p>` : ''}
                        <input 
                            type="text" 
                            id="url_${link.name}" 
                            value="${link.url}" 
                            class="w-full px-4 py-2 bg-gray-600 border border-gray-500 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition placeholder-gray-400"
                            placeholder="링크 URL을 입력하세요"
                        >
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="saveLink('${link.name}')" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                        >
                            저장
                        </button>
                        <button 
                            onclick="deleteLink('${link.name}')" 
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
                        >
                            삭제
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 링크 저장
        async function saveLink(name) {
            const urlInput = document.getElementById(`url_${name}`);
            const url = urlInput.value.trim();

            if (!url) {
                showError('URL을 입력해주세요.');
                return;
            }

            // 해당 링크의 description 찾기
            const linkContainer = urlInput.closest('.border');
            const description = linkContainer.querySelector('p')?.textContent || '';

            try {
                const response = await fetch('/api/links', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        url: url,
                        description: description
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('링크가 저장되었습니다.');
                    setTimeout(loadLinks, 1000);
                } else {
                    showError(data.message || '링크 저장에 실패했습니다.');
                }
            } catch (error) {
                showError('네트워크 오류가 발생했습니다.');
            }
        }

        // 링크 삭제
        async function deleteLink(name) {
            if (!confirm(`"${name}" 링크를 삭제하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/links?name=${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('링크가 삭제되었습니다.');
                    setTimeout(loadLinks, 1000);
                } else {
                    showError(data.message || '링크 삭제에 실패했습니다.');
                }
            } catch (error) {
                showError('네트워크 오류가 발생했습니다.');
            }
        }

        // 링크 등록 폼 처리
        document.getElementById('addLinkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            const description = document.getElementById('linkDescription').value.trim();
            const successDiv = document.getElementById('addLinkSuccessMessage');
            const errorDiv = document.getElementById('addLinkErrorMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // 에러/성공 메시지 숨기기
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            // 유효성 검사
            if (!name || !url) {
                errorDiv.textContent = '링크 이름과 URL은 필수입니다.';
                errorDiv.classList.remove('hidden');
                return;
            }

            // 링크 이름 유효성 검사 (영문, 숫자, 언더스코어만)
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                errorDiv.textContent = '링크 이름은 영문, 숫자, 언더스코어만 사용할 수 있습니다.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = '등록 중...';
            
            try {
                const response = await fetch('/api/links', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        url: url,
                        description: description || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = '링크가 등록되었습니다.';
                    successDiv.classList.remove('hidden');
                    // 폼 초기화
                    e.target.reset();
                    setTimeout(() => {
                        successDiv.classList.add('hidden');
                        switchTab('links');
                    }, 2000);
                } else {
                    errorDiv.textContent = data.message || '링크 등록에 실패했습니다.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = '네트워크 오류가 발생했습니다.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '링크 등록';
            }
        });

        // 성공 메시지 표시
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const errorDiv = document.getElementById('errorMessage');
            
            errorDiv.classList.add('hidden');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        // 에러 메시지 표시
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.classList.add('hidden');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // 비밀번호 변경 폼 처리
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const successDiv = document.getElementById('passwordSuccessMessage');
            const errorDiv = document.getElementById('passwordErrorMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // 에러/성공 메시지 숨기기
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            // 비밀번호 확인 검증
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = '새 비밀번호가 일치하지 않습니다.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 4) {
                errorDiv.textContent = '비밀번호는 최소 4자 이상이어야 합니다.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = '변경 중...';
            
            try {
                const response = await fetch('/api/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = data.message || '비밀번호가 변경되었습니다.';
                    successDiv.classList.remove('hidden');
                    // 폼 초기화
                    e.target.reset();
                    setTimeout(() => {
                        successDiv.classList.add('hidden');
                    }, 3000);
                } else {
                    errorDiv.textContent = data.message || '비밀번호 변경에 실패했습니다.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = '네트워크 오류가 발생했습니다.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '비밀번호 변경';
            }
        });

        // 페이지 로드 시 링크 불러오기
        loadLinks();
    </script>
</body>
</html>
